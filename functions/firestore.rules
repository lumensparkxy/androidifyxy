rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Public reads for mandi prices (existing feature)
    match /mandi_prices/{docId} {
      allow read: if true;
    }

    // Metadata for sync status (written by Cloud Functions, public read for monitoring)
    match /metadata/{docId} {
      allow read: if true;
      // Write is handled by Cloud Functions with admin SDK (bypasses rules)
    }

    // Existing user settings (mandi preferences) remain writable by the user
    match /users/{userId}/settings/{docId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }

    // Supplier profile — only the owner can manage their document.
    // Public can read approved suppliers for offer contact info.
    match /suppliers/{supplierId} {
      allow read: if resource.data.verificationStatus == 'APPROVED'
        || (request.auth != null && request.auth.uid == supplierId);

      allow create: if request.auth != null
        && request.auth.uid == supplierId
        && request.resource.data.ownerUid == request.auth.uid
        && request.resource.data.verificationStatus == 'PENDING';

      // Owners can update their profile but cannot approve themselves.
      allow update: if request.auth != null
        && request.auth.uid == supplierId
        && request.resource.data.ownerUid == resource.data.ownerUid
        && request.resource.data.verificationStatus == resource.data.verificationStatus;
    }

    // Offers — public reads only for approved offers from approved suppliers. Owners can manage their own offers.
    match /offers/{offerId} {
      allow read: if (resource.data.status == 'APPROVED' && resource.data.supplierApproved == true)
        || (request.auth != null && resource.data.supplierId == request.auth.uid);

      // Suppliers create drafts only.
      allow create: if request.auth != null
        && request.resource.data.supplierId == request.auth.uid
        && request.resource.data.status == 'DRAFT'
        && request.resource.data.supplierApproved == false;

      // Suppliers may edit their own non-active offers but cannot self-activate or mark approved.
      allow update: if request.auth != null
        && resource.data.supplierId == request.auth.uid
        && !(resource.data.status != 'ACTIVE' && request.resource.data.status == 'ACTIVE')
        && request.resource.data.supplierApproved == resource.data.supplierApproved;
    }

    // Carbon Credits submissions — authenticated users can create their own submissions
    match /carbon_credits/{submissionId} {
      // Allow authenticated users to create submissions with their own userId
      allow create: if request.auth != null
        && request.resource.data.userId == request.auth.uid;

      // Users can read their own submissions
      allow read: if request.auth != null
        && resource.data.userId == request.auth.uid;
    }

    // Voice usage tracking — users can only access their own usage document
    // Document ID is the user's UID for easy access
    match /voice_usage/{userId} {
      // Users can read their own usage
      allow read: if request.auth != null
        && request.auth.uid == userId;

      // Users can create their own usage document
      allow create: if request.auth != null
        && request.auth.uid == userId;

      // Users can update their own usage (for recording session time)
      allow update: if request.auth != null
        && request.auth.uid == userId;
    }

    // Conversations — users can only access their own conversations
    match /conversations/{conversationId} {
      // Users can read their own conversations
      allow read: if request.auth != null
        && resource.data.userId == request.auth.uid;

      // Users can create conversations with their own userId
      allow create: if request.auth != null
        && request.resource.data.userId == request.auth.uid;

      // Users can update their own conversations
      allow update: if request.auth != null
        && resource.data.userId == request.auth.uid
        && request.resource.data.userId == request.auth.uid;

      // Users can delete their own conversations
      allow delete: if request.auth != null
        && resource.data.userId == request.auth.uid;
    }

    // Deny everything else by default
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
