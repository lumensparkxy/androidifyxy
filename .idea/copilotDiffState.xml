<?xml version="1.0" encoding="UTF-8"?>
<project version="4">
  <component name="CopilotDiffPersistence">
    <option name="pendingDiffs">
      <map>
        <entry key="$PROJECT_DIR$/app/src/main/java/com/maswadkar/developers/androidify/auth/AuthRepository.kt">
          <value>
            <PendingDiffInfo>
              <option name="filePath" value="$PROJECT_DIR$/app/src/main/java/com/maswadkar/developers/androidify/auth/AuthRepository.kt" />
              <option name="originalContent" value="package com.maswadkar.developers.androidify.auth&#10;&#10;import android.content.Context&#10;import androidx.credentials.ClearCredentialStateRequest&#10;import androidx.credentials.CredentialManager&#10;import androidx.credentials.CustomCredential&#10;import androidx.credentials.GetCredentialRequest&#10;import androidx.credentials.GetCredentialResponse&#10;import com.google.android.libraries.identity.googleid.GetGoogleIdOption&#10;import com.google.android.libraries.identity.googleid.GoogleIdTokenCredential&#10;import com.google.android.libraries.identity.googleid.GoogleIdTokenParsingException&#10;import com.google.firebase.auth.FirebaseAuth&#10;import com.google.firebase.auth.FirebaseUser&#10;import com.google.firebase.auth.GoogleAuthProvider&#10;import kotlinx.coroutines.tasks.await&#10;&#10;class AuthRepository(private val context: Context) {&#10;&#10;    private val firebaseAuth: FirebaseAuth = FirebaseAuth.getInstance()&#10;    private val credentialManager: CredentialManager = CredentialManager.create(context)&#10;&#10;    // Web client ID from google-services.json (client_type: 3)&#10;    companion object {&#10;        private const val WEB_CLIENT_ID = &quot;989917723212-fnqfnfqcjjh66mqtdkp9t15uv2mf5bu4.apps.googleusercontent.com&quot;&#10;    }&#10;&#10;    val currentUser: FirebaseUser?&#10;        get() = firebaseAuth.currentUser&#10;&#10;    fun isUserSignedIn(): Boolean = currentUser != null&#10;&#10;    suspend fun signInWithGoogle(): Result&lt;FirebaseUser&gt; {&#10;        return try {&#10;            val googleIdOption = GetGoogleIdOption.Builder()&#10;                .setFilterByAuthorizedAccounts(false)&#10;                .setServerClientId(WEB_CLIENT_ID)&#10;                .setAutoSelectEnabled(true)&#10;                .build()&#10;&#10;            val request = GetCredentialRequest.Builder()&#10;                .addCredentialOption(googleIdOption)&#10;                .build()&#10;&#10;            val result = credentialManager.getCredential(&#10;                request = request,&#10;                context = context as android.app.Activity&#10;            )&#10;&#10;            handleSignInResult(result)&#10;        } catch (e: Exception) {&#10;            Result.failure(e)&#10;        }&#10;    }&#10;&#10;    private suspend fun handleSignInResult(result: GetCredentialResponse): Result&lt;FirebaseUser&gt; {&#10;        val credential = result.credential&#10;&#10;        return when {&#10;            credential is CustomCredential &amp;&amp;&#10;            credential.type == GoogleIdTokenCredential.TYPE_GOOGLE_ID_TOKEN_CREDENTIAL -&gt; {&#10;                try {&#10;                    val googleIdTokenCredential = GoogleIdTokenCredential.createFrom(credential.data)&#10;                    val idToken = googleIdTokenCredential.idToken&#10;&#10;                    val firebaseCredential = GoogleAuthProvider.getCredential(idToken, null)&#10;                    val authResult = firebaseAuth.signInWithCredential(firebaseCredential).await()&#10;&#10;                    authResult.user?.let {&#10;                        Result.success(it)&#10;                    } ?: Result.failure(Exception(&quot;Firebase authentication failed&quot;))&#10;                } catch (e: GoogleIdTokenParsingException) {&#10;                    Result.failure(Exception(&quot;Invalid Google ID token&quot;))&#10;                }&#10;            }&#10;            else -&gt; Result.failure(Exception(&quot;Unexpected credential type&quot;))&#10;        }&#10;    }&#10;&#10;    suspend fun signOut() {&#10;        firebaseAuth.signOut()&#10;        try {&#10;            credentialManager.clearCredentialState(ClearCredentialStateRequest())&#10;        } catch (e: Exception) {&#10;            // Ignore credential clear errors&#10;        }&#10;    }&#10;}&#10;&#10;" />
              <option name="updatedContent" value="package com.maswadkar.developers.androidify.auth&#10;&#10;import android.content.Context&#10;import android.util.Log&#10;import androidx.credentials.ClearCredentialStateRequest&#10;import androidx.credentials.CredentialManager&#10;import androidx.credentials.CustomCredential&#10;import androidx.credentials.GetCredentialRequest&#10;import androidx.credentials.GetCredentialResponse&#10;import androidx.credentials.exceptions.GetCredentialCancellationException&#10;import androidx.credentials.exceptions.GetCredentialException&#10;import androidx.credentials.exceptions.NoCredentialException&#10;import com.google.android.libraries.identity.googleid.GetGoogleIdOption&#10;import com.google.android.libraries.identity.googleid.GetSignInWithGoogleOption&#10;import com.google.android.libraries.identity.googleid.GoogleIdTokenCredential&#10;import com.google.android.libraries.identity.googleid.GoogleIdTokenParsingException&#10;import com.google.firebase.auth.FirebaseAuth&#10;import com.google.firebase.auth.FirebaseUser&#10;import com.google.firebase.auth.GoogleAuthProvider&#10;import kotlinx.coroutines.tasks.await&#10;&#10;class AuthRepository(private val context: Context) {&#10;&#10;    private val firebaseAuth: FirebaseAuth = FirebaseAuth.getInstance()&#10;    private val credentialManager: CredentialManager = CredentialManager.create(context)&#10;&#10;    // Web client ID from google-services.json (client_type: 3)&#10;    companion object {&#10;        private const val TAG = &quot;AuthRepository&quot;&#10;        private const val WEB_CLIENT_ID = &quot;989917723212-fnqfnfqcjjh66mqtdkp9t15uv2mf5bu4.apps.googleusercontent.com&quot;&#10;    }&#10;&#10;    val currentUser: FirebaseUser?&#10;        get() = firebaseAuth.currentUser&#10;&#10;    fun isUserSignedIn(): Boolean = currentUser != null&#10;&#10;    suspend fun signInWithGoogle(): Result&lt;FirebaseUser&gt; {&#10;        return try {&#10;            // First try with saved credentials&#10;            trySignInWithSavedCredentials()&#10;        } catch (e: NoCredentialException) {&#10;            // No saved credentials, show Google Sign-In button flow&#10;            Log.d(TAG, &quot;No saved credentials, showing sign-in UI&quot;)&#10;            trySignInWithGoogleButton()&#10;        } catch (e: GetCredentialCancellationException) {&#10;            Result.failure(Exception(&quot;Sign-in was cancelled&quot;))&#10;        } catch (e: GetCredentialException) {&#10;            Log.e(TAG, &quot;GetCredentialException: ${e.message}&quot;)&#10;            // Fallback to sign-in button flow&#10;            trySignInWithGoogleButton()&#10;        } catch (e: Exception) {&#10;            Log.e(TAG, &quot;Sign-in error: ${e.message}&quot;)&#10;            Result.failure(e)&#10;        }&#10;    }&#10;&#10;    private suspend fun trySignInWithSavedCredentials(): Result&lt;FirebaseUser&gt; {&#10;        val googleIdOption = GetGoogleIdOption.Builder()&#10;            .setFilterByAuthorizedAccounts(true)&#10;            .setServerClientId(WEB_CLIENT_ID)&#10;            .setAutoSelectEnabled(true)&#10;            .build()&#10;&#10;        val request = GetCredentialRequest.Builder()&#10;            .addCredentialOption(googleIdOption)&#10;            .build()&#10;&#10;        val result = credentialManager.getCredential(&#10;            request = request,&#10;            context = context as android.app.Activity&#10;        )&#10;&#10;        return handleSignInResult(result)&#10;    }&#10;&#10;    private suspend fun trySignInWithGoogleButton(): Result&lt;FirebaseUser&gt; {&#10;        return try {&#10;            val signInWithGoogleOption = GetSignInWithGoogleOption.Builder(WEB_CLIENT_ID)&#10;                .build()&#10;&#10;            val request = GetCredentialRequest.Builder()&#10;                .addCredentialOption(signInWithGoogleOption)&#10;                .build()&#10;&#10;            val result = credentialManager.getCredential(&#10;                request = request,&#10;                context = context as android.app.Activity&#10;            )&#10;&#10;            handleSignInResult(result)&#10;        } catch (e: GetCredentialCancellationException) {&#10;            Result.failure(Exception(&quot;Sign-in was cancelled&quot;))&#10;        } catch (e: Exception) {&#10;            Log.e(TAG, &quot;Sign-in with Google button failed: ${e.message}&quot;)&#10;            Result.failure(e)&#10;        }&#10;    }&#10;&#10;    private suspend fun handleSignInResult(result: GetCredentialResponse): Result&lt;FirebaseUser&gt; {&#10;        val credential = result.credential&#10;&#10;        return when {&#10;            credential is CustomCredential &amp;&amp;&#10;            credential.type == GoogleIdTokenCredential.TYPE_GOOGLE_ID_TOKEN_CREDENTIAL -&gt; {&#10;                try {&#10;                    val googleIdTokenCredential = GoogleIdTokenCredential.createFrom(credential.data)&#10;                    val idToken = googleIdTokenCredential.idToken&#10;&#10;                    val firebaseCredential = GoogleAuthProvider.getCredential(idToken, null)&#10;                    val authResult = firebaseAuth.signInWithCredential(firebaseCredential).await()&#10;&#10;                    authResult.user?.let {&#10;                        Result.success(it)&#10;                    } ?: Result.failure(Exception(&quot;Firebase authentication failed&quot;))&#10;                } catch (e: GoogleIdTokenParsingException) {&#10;                    Log.e(TAG, &quot;Token parsing error: ${e.message}&quot;)&#10;                    Result.failure(Exception(&quot;Invalid Google ID token&quot;))&#10;                }&#10;            }&#10;            else -&gt; {&#10;                Log.e(TAG, &quot;Unexpected credential type: ${credential.type}&quot;)&#10;                Result.failure(Exception(&quot;Unexpected credential type&quot;))&#10;            }&#10;        }&#10;    }&#10;&#10;    suspend fun signOut() {&#10;        firebaseAuth.signOut()&#10;        try {&#10;            credentialManager.clearCredentialState(ClearCredentialStateRequest())&#10;        } catch (e: Exception) {&#10;            // Ignore credential clear errors&#10;        }&#10;    }&#10;}" />
            </PendingDiffInfo>
          </value>
        </entry>
      </map>
    </option>
  </component>
</project>